<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiStock ‚Äì Multi-Agent Stock Analysis Chatbot üìà</title>

    <style>
        :root {
            --bg-color: #f5f7fa;
            --container-bg: #ffffff;
            --text-color: #222;
            --border-color: #e3e5e8;
            --accent-color: #0066ff;
            --accent-hover: #004fcc;
            --user-msg: #eef5ff;
            --ai-msg: #fdfdfd;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
        }
        #chat-container {
            width: 100%;
            max-width: 900px;
            height: 100vh;
            background-color: var(--container-bg);
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        #chat-header {
            padding: 18px 25px;
            border-bottom: 1px solid var(--border-color);
            background: white;
        }
        #chat-header h2 {
            margin: 0;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        #chat-box {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
        }
        .msg-block {
            margin-bottom: 18px;
        }
        .user-msg, .ai-msg {
            padding: 14px 18px;
            border-radius: 10px;
            line-height: 1.6;
            white-space: pre-wrap;
            font-size: 15px;
        }
        .user-msg {
            background: var(--user-msg);
            border: 1px solid var(--border-color);
        }
        .ai-msg {
            background: var(--ai-msg);
            border: 1px solid var(--border-color);
            font-family: "SF Mono", "Fira Code", Consolas, monospace;
        }
        #input-area {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }
        #user-input {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            padding: 12px 18px;
            font-size: 16px;
        }
        #user-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.15);
        }
        #send-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.2s;
        }
        #send-btn:hover {
            background-color: var(--accent-hover);
        }
        #typing-indicator {
            display: none;
            padding: 5px 20px;
            color: #999;
            font-size: 14px;
        }
        @media screen and (max-width: 600px) {
            #chat-container {
                border-left: none;
                border-right: none;
            }
            #chat-header h2 {
                font-size: 18px;
            }
        }
    </style>
</head>

<body>
<div id="chat-container">

    <div id="chat-header">
        <h2>üìà DigiStock ‚Äì AI Stock Analyzer</h2>
    </div>

    <div id="chat-box">
        <div class="msg-block ai-msg">
            Welcome! I‚Äôm a multi-agent AI analyst powered by real-time data, technical indicators, and ML predictions.
            <br><br>Ask anything like:
            <br>‚Ä¢ *‚ÄúGive me short-term NSE stock picks‚Äù*
            <br>‚Ä¢ *‚ÄúAnalyze RELIANCE for tomorrow‚Äù*
            <br>‚Ä¢ *‚ÄúCompare INFY vs TCS with indicators‚Äù*
        </div>
    </div>

    <div id="typing-indicator">ü§ñ AI is analyzing...</div>

    <div id="input-area">
        <input
            type="text"
            id="user-input"
            placeholder="Type your query‚Ä¶"
            value="Give me good stock recommendation from NSE for short term trading"
        >
        <button id="send-btn">Send</button>
    </div>
</div>

<script>
const chatBox = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const typingIndicator = document.getElementById('typing-indicator');

// Event listeners
sendBtn.addEventListener('click', sendMessage);
userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

// Main sendMessage function
async function sendMessage() {
    const query = userInput.value.trim();
    if (!query) return;

    appendUserMessage(query);
    userInput.value = '';
    toggleInput(true);

    const aiMsgElement = appendAIMessage("");

    typingIndicator.style.display = "block";

    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query })
        });

        if (!response.ok) throw new Error("Server error " + response.status);

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            aiMsgElement.textContent += decoder.decode(value, { stream: true });
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    } catch (err) {
        aiMsgElement.textContent += `\n\n‚ö†Ô∏è Error: Unable to fetch response. Check backend logs.`;
        console.error(err);
    }

    typingIndicator.style.display = "none";
    toggleInput(false);
}

function appendUserMessage(text) {
    const block = document.createElement("div");
    block.className = "msg-block user-msg";
    block.textContent = "üë§ You:\n" + text;
    chatBox.appendChild(block);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function appendAIMessage(initialText) {
    const block = document.createElement("div");
    block.className = "msg-block ai-msg";
    block.textContent = initialText || "ü§ñ AI Analyst:\n";
    chatBox.appendChild(block);
    chatBox.scrollTop = chatBox.scrollHeight;
    return block;
}

function toggleInput(disabled) {
    userInput.disabled = disabled;
    sendBtn.disabled = disabled;
    if (!disabled) userInput.focus();
}
</script>

</body>
</html>
